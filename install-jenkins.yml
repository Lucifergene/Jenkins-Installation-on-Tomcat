---
- name: Install Jenkins with War file
  hosts: all
  vars:
    tomcat_version: 8.5.69
    tomcat_url: "https://downloads.apache.org/tomcat/tomcat-{{tomcat_version.split('.')[0]}}/v{{tomcat_version}}/bin/apache-tomcat-{{tomcat_version}}.tar.gz"
    tomcat_dir: /usr/local
  become: true

  tasks:
    - name: Update packages list
      yum:
        name: "*"
        state: latest
        update_cache: yes

    - name: Installing OpenJDK
      yum:
        name: java-1.8.0-openjdk
        
    - name: Downloading Tomcat
      get_url: 
        url: "{{tomcat_url}}"
        dest: "{{tomcat_dir}}"

    - name: Extracting Tomcat
      unarchive:
        src: "{{tomcat_dir}}/apache-tomcat-{{tomcat_version}}.tar.gz"
        dest: "{{tomcat_dir}}"
        remote_src: yes
      
    - name: Renaming Tomcat Home
      command: mv {{tomcat_dir}}/apache-tomcat-{{tomcat_version}} {{tomcat_dir}}/tomcat
    
    # - name: Starting Tomcat
    #   shell: nohup {{tomcat_dir}}/tomcat/bin/startup.sh &

    - name: Adding Firewall Rule to expose HTTP/HTTPS
      command: firewall-cmd --permanent --add-service=http --add-service=https

    - name: Reload firewall
      service: 
        name: firewalld
        state: restarted

    - name: Create Systemctl
      template:
        src: tomcat.service.j2
        dest: /etc/systemd/system/tomcat.service

    - name: Stop service tomcat 
      ansible.builtin.systemd:
        state: stopped
        daemon_reload: yes
        name: tomcat
    
    # - name: Start service tomcat 
    #   ansible.builtin.systemd:
    #     state: started
    #     name: tomcat

    

    
